# Diagramas de Flujo - Rotaciรณn de Tokens

## 1. Flujo de Login Inicial

```
โโโโโโโโโโโโ
โ  Cliente โ
โโโโโโฌโโโโโโ
     โ POST /auth/login
     โ { email, password }
     โผ
โโโโโโโโโโโโโโโโโโ
โ  AuthService   โ
โ  login()       โ
โโโโโโฌโโโโโโโโโโโโ
     โ
     โ 1. Verificar credenciales
     โ 2. Verificar no baneado
     โ
     โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  generateTokenPair()   โ
โโโโโโโโโโโโโโโโโโโโโโโโโโค
โ familyId = uuid()      โ
โ accessJti = uuid()     โ
โ refreshJti = uuid()    โ
โโโโโโฌโโโโโโโโโโโโโโโโโโโโ
     โ
     โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
     โ                              โ
     โผ                              โผ
โโโโโโโโโโโโโโโโโโโ      โโโโโโโโโโโโโโโโโโโโ
โ  Access Token   โ      โ  Refresh Token   โ
โโโโโโโโโโโโโโโโโโโค      โโโโโโโโโโโโโโโโโโโโค
โ jti: access-123 โ      โ jti: refresh-456 โ
โ type: 'access'  โ      โ type: 'refresh'  โ
โ exp: 15m        โ      โ familyId: fam-1  โ โโโ NUEVO
โ โ NO familyId  โ      โ exp: 7d          โ
โโโโโโโโโโโโโโโโโโโ      โโโโโโโโโโโโโโโโโโโโ
     โ                              โ
     โ                              โ
     โโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโ
                    โ
                    โผ
         โโโโโโโโโโโโโโโโโโโโโโโโ
         โ  tokenFamilies Map   โ
         โโโโโโโโโโโโโโโโโโโโโโโโค
         โ fam-1: {             โ
         โ   userId: user-123   โ
         โ   currentJti: ref-456โ
         โ   createdAt: now     โ
         โ }                    โ
         โโโโโโโโโโโโโโโโโโโโโโโโ
```

## 2. Flujo de Rotaciรณn Exitosa

```
โโโโโโโโโโโโ
โ  Cliente โ
โโโโโโฌโโโโโโ
     โ POST /auth/refresh
     โ { refreshToken: "token-A" }
     โ
     โผ
โโโโโโโโโโโโโโโโโโโโโโ
โ  refreshTokens()   โ
โโโโโโฌโโโโโโโโโโโโโโโโ
     โ
     โ 1. Verificar firma JWT โ
     โ 2. Extraer payload
     โ    { jti: "ref-456", familyId: "fam-1" }
     โ
     โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  isTokenUsed(ref-456)? โ
โโโโโโฌโโโโโโโโโโโโโโโโโโโโ
     โ
     โผ NO (primera vez)
     โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  isFamilyCompromised(fam-1)?โ
โโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโ
     โ
     โผ NO (sesiรณn vรกlida)
     โ
โโโโโโโโโโโโโโโโโโโโโโ
โ  Verificar usuario โ
โ  - Existe? โ       โ
โ  - Baneado? โ      โ
โโโโโโฌโโโโโโโโโโโโโโโโ
     โ
     โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  rotateTokenPair()       โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ 1. Generar nuevos JTIs   โ
โ    accessJti = uuid()    โ
โ    refreshJti = uuid()   โ
โ                          โ
โ 2. Marcar token usado    โ
โ    usedTokens.set(       โ
โ      "ref-456",          โ
โ      { expiresAt, ... }  โ
โ    )                     โ
โ                          โ
โ 3. Actualizar familia    โ
โ    tokenFamilies.get(    โ
โ      "fam-1"             โ
โ    ).currentJti =        โ
โ      "ref-789"           โ
โ                          โ
โ 4. Crear nuevos tokens   โ
โ    mantener familyId     โ
โโโโโโฌโโโโโโโโโโโโโโโโโโโโโโ
     โ
     โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
     โ                              โ
     โผ                              โผ
โโโโโโโโโโโโโโโโโโโ      โโโโโโโโโโโโโโโโโโโโ
โ  Access Token B โ      โ  Refresh Token B โ
โโโโโโโโโโโโโโโโโโโค      โโโโโโโโโโโโโโโโโโโโค
โ jti: access-777 โ      โ jti: refresh-789 โ
โ exp: 15m        โ      โ familyId: fam-1  โ โโโ MISMO familyId
โโโโโโโโโโโโโโโโโโโ      โโโโโโโโโโโโโโโโโโโโ
     โ                              โ
     โโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโ
                    โ
                    โผ
              โโโโโโโโโโโโ
              โ  Cliente โ
              โโโโโโโโโโโโ
              Guardar nuevos tokens
              Token A ahora INVรLIDO
```

## 3. Flujo de Ataque Detectado (Token Reuse)

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  Escenario: Atacante interceptรณ Token A        โ
โ  Usuario ya rotรณ Token A โ Token B             โ
โ  Atacante intenta usar Token A (ya usado)      โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

โโโโโโโโโโโโ
โ Atacante โ
โโโโโโฌโโโโโโ
     โ POST /auth/refresh
     โ { refreshToken: "token-A" } โโโ Token YA usado
     โ
     โผ
โโโโโโโโโโโโโโโโโโโโโโ
โ  refreshTokens()   โ
โโโโโโฌโโโโโโโโโโโโโโโโ
     โ
     โ 1. Verificar firma JWT โ
     โ 2. Extraer payload
     โ    { jti: "ref-456", familyId: "fam-1" }
     โ
     โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  isTokenUsed(ref-456)? โ
โโโโโโฌโโโโโโโโโโโโโโโโโโโโ
     โ
     โผ Sร โ (ยกYa fue usado!)
     โ
     โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  ๐จ SECURITY ALERT                      โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ  console.error(                         โ
โ    "[SECURITY ALERT]                    โ
โ     Token reuse attack detected!        โ
โ     JTI: ref-456                        โ
โ     FamilyID: fam-1                     โ
โ     UserID: user-123                    โ
โ     Time: 2026-01-27..."                โ
โ  )                                      โ
โโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
     โ
     โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  invalidateTokenFamily("fam-1")         โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ  tokenFamilies.get("fam-1")             โ
โ    .invalidatedAt = now                 โ
โ                                         โ
โ  console.warn(                          โ
โ    "[SECURITY] Token family             โ
โ     compromised: fam-1                  โ
โ     Reason: Token reuse attack"         โ
โ  )                                      โ
โโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
     โ
     โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  throw UnauthorizedError(               โ
โ    "Actividad sospechosa detectada.     โ
โ     Por seguridad, todas tus sesiones   โ
โ     han sido cerradas."                 โ
โ  )                                      โ
โโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
     โ
     โผ
โโโโโโโโโโโโ
โ Atacante โ  โโโ Error 401
โโโโโโโโโโโโ

โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  Efecto Colateral: Usuario Legรญtimo         โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

โโโโโโโโโโโโ
โ Usuario  โ
โโโโโโฌโโโโโโ
     โ Intenta usar Token B (era vรกlido)
     โ POST /auth/refresh
     โ
     โผ
โโโโโโโโโโโโโโโโโโโโโโ
โ  refreshTokens()   โ
โโโโโโฌโโโโโโโโโโโโโโโโ
     โ
     โ Verificar familyId: "fam-1"
     โ
     โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  isFamilyCompromised(fam-1)?โ
โโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโ
     โ
     โผ Sร โ (familia invalidada)
     โ
     โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  throw UnauthorizedError(               โ
โ    "Sesiรณn invalidada por seguridad.    โ
โ     Por favor, inicia sesiรณn            โ
โ     nuevamente."                        โ
โ  )                                      โ
โโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
     โ
     โผ
โโโโโโโโโโโโ
โ Usuario  โ  โโโ Forzado a re-login
โโโโโโโโโโโโ  โโโ Recibe notificaciรณn de actividad sospechosa
```

## 4. Estructura de Datos en Memoria

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  AuthService                                        โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ                                                     โ
โ  usedTokens: Map<jti, UsedToken>                   โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ โ
โ  โ "ref-456" โ {                                 โ โ
โ  โ   jti: "ref-456",                             โ โ
โ  โ   familyId: "fam-1",                          โ โ
โ  โ   userId: "user-123",                         โ โ
โ  โ   usedAt: 1738000000,                         โ โ
โ  โ   expiresAt: 1738604800                       โ โ
โ  โ }                                             โ โ
โ  โ                                               โ โ
โ  โ "ref-789" โ { ... }                           โ โ
โ  โ "ref-111" โ { ... }                           โ โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ โ
โ                                                     โ
โ  tokenFamilies: Map<familyId, TokenFamily>         โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ โ
โ  โ "fam-1" โ {                                   โ โ
โ  โ   familyId: "fam-1",                          โ โ
โ  โ   userId: "user-123",                         โ โ
โ  โ   createdAt: 1738000000,                      โ โ
โ  โ   currentJti: "ref-999",                      โ โ
โ  โ   invalidatedAt: undefined  โ ACTIVA          โ โ
โ  โ }                                             โ โ
โ  โ                                               โ โ
โ  โ "fam-2" โ {                                   โ โ
โ  โ   ...                                         โ โ
โ  โ   invalidatedAt: 1738000050  โ COMPROMETIDA โ โ
โ  โ }                                             โ โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ โ
โ                                                     โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

## 5. Limpieza Automรกtica de Tokens

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  setInterval(() => {                    โ
โ    cleanupExpiredTokens()               โ
โ  }, 60 * 60 * 1000)  // cada 1 hora     โ
โโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
     โ
     โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  cleanupExpiredTokens()                 โ
โโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
     โ
     โโโโโโโโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโ
     โ                    โ                    โ
     โผ                    โผ                    โผ
โโโโโโโโโโโโโโโโ  โโโโโโโโโโโโโโโโ  โโโโโโโโโโโโโโโโ
โ Limpiar      โ  โ Limpiar      โ  โ Limpiar      โ
โ usedTokens   โ  โ familias     โ  โ logs         โ
โ expirados    โ  โ invalidadas  โ  โ antiguos     โ
โ              โ  โ > 7 dรญas     โ  โ              โ
โโโโโโโโโโโโโโโโ  โโโโโโโโโโโโโโโโ  โโโโโโโโโโโโโโโโ

const now = Math.floor(Date.now() / 1000)

// Limpiar tokens usados expirados
for (const [jti, token] of usedTokens) {
  if (token.expiresAt < now) {
    usedTokens.delete(jti)  โโโ Liberar memoria
  }
}

// Limpiar familias antiguas (> 7 dรญas comprometidas)
const sevenDaysAgo = now - 7 * 24 * 60 * 60
for (const [familyId, family] of tokenFamilies) {
  if (family.invalidatedAt < sevenDaysAgo) {
    tokenFamilies.delete(familyId)  โโโ Liberar memoria
  }
}
```

## 6. Logout Global (revokeAllTokens)

```
โโโโโโโโโโโโ
โ  Cliente โ
โโโโโโฌโโโโโโ
     โ POST /auth/logout-all
     โ
     โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  revokeAllTokens(userId)   โ
โโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโ
     โ
     โ Buscar todas las familias del usuario
     โ
     โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  for (const [familyId, family]           โ
โ       of tokenFamilies) {                โ
โ    if (family.userId === userId &&       โ
โ        !family.invalidatedAt) {          โ
โ      invalidateTokenFamily(familyId)     โ
โ    }                                     โ
โ  }                                       โ
โโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
     โ
     โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  Estado Final:                         โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ  fam-1 (user-123): โ invalidatedAt    โ
โ  fam-2 (user-123): โ invalidatedAt    โ
โ  fam-3 (user-123): โ invalidatedAt    โ
โ  fam-4 (user-456): โ  activa           โ
โโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
     โ
     โผ
โโโโโโโโโโโโ
โ  Cliente โ  โโโ { success: true,
โโโโโโโโโโโโ       invalidatedSessions: 3 }
                   Usuario debe re-login
```

## 7. Comparaciรณn: Antes vs Ahora

### ANTES (Sin Rotaciรณn)

```
Login โ Token A
        โ
        โโโ Refresh โ Token A (reutilizable)
        โโโ Refresh โ Token A (reutilizable)
        โโโ Refresh โ Token A (reutilizable)
        โโโ ...

โ Token A puede usarse mรบltiples veces
โ Si es robado, el atacante puede refrescar indefinidamente
โ No hay forma de detectar el robo
```

### AHORA (Con Rotaciรณn)

```
Login โ Token A (fam-1)
        โ
        โโโ Refresh โ Token B (fam-1)
        โ             Token A โ USADO โ
        โ
        โโโ Refresh โ Token C (fam-1)
        โ             Token B โ USADO โ
        โ
        โโโ Token A intenta refresh
                     โ
            โ DETECTADO: Token reuse attack
            โ FAMILIA fam-1 COMPROMETIDA
            โ Tokens B y C INVALIDADOS
            โ Usuario debe re-login
```

## 8. Migraciรณn Futura a Redis

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  MEMORIA (Actual)         โ  REDIS (Futuro)     โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ                                                 โ
โ  usedTokens Map           โ  Redis Hashes      โ
โ  โโ jti-123: {...}        โ  HSET used:jti-123 โ
โ  โโ jti-456: {...}        โ  SETEX 604800      โ
โ                                                 โ
โ  tokenFamilies Map        โ  Redis Hashes      โ
โ  โโ fam-1: {...}          โ  HSET family:fam-1 โ
โ  โโ fam-2: {...}          โ  SETEX 604800      โ
โ                                                 โ
โ  cleanupExpiredTokens()   โ  TTL automรกtico     โ
โ  โโ setInterval(...)      โ  EXPIRE key secondsโ
โ  โโ manual deletion       โ  Redis auto-delete โ
โ                                                 โ
โ  โ Clustering             โ  โ Multi-instancia โ
โ  โ Pierde en restart     โ  โ Persistente     โ
โ  โ Solo 1 instancia      โ  โ Load balanced   โ
โ                                                 โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

Ejemplo Redis:

# Marcar token usado
SETEX used:ref-456 604800 '{"familyId":"fam-1","userId":"user-123"}'

# Verificar si token usado
EXISTS used:ref-456  โ 1 (usado) o 0 (no usado)

# Invalidar familia
SETEX family:fam-1 604800 '{"invalidatedAt":1738000000}'

# TTL automรกtico - Redis limpia automรกticamente
TTL used:ref-456  โ segundos restantes
```

## Resumen Visual de Seguridad

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  Capas de Seguridad Implementadas                     โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ                                                       โ
โ  1๏ธโฃ  Firma JWT (jose)                                โ
โ      โ Verificaciรณn de firma                         โ
โ      โ Expiraciรณn automรกtica                         โ
โ                                                       โ
โ  2๏ธโฃ  Token Rotation                                  โ
โ      โ Uso รบnico por refresh token                   โ
โ      โ Generaciรณn de nuevo par                       โ
โ                                                       โ
โ  3๏ธโฃ  Family Tracking                                 โ
โ      โ Todos tokens relacionados                     โ
โ      โ Invalidaciรณn en cascada                       โ
โ                                                       โ
โ  4๏ธโฃ  Reuse Detection                                 โ
โ      โ Lista de tokens usados                        โ
โ      โ Detecciรณn inmediata                           โ
โ                                                       โ
โ  5๏ธโฃ  Automatic Invalidation                          โ
โ      โ Compromiso de familia completa                โ
โ      โ Forzar re-login                               โ
โ                                                       โ
โ  6๏ธโฃ  Security Logging                                โ
โ      โ Alertas detalladas                            โ
โ      โ Auditorรญa completa                            โ
โ                                                       โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```
