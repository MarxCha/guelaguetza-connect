# ============================================
# CONTINUOUS INTEGRATION - Guelaguetza Connect
# ============================================
# Ejecuta en: Push a cualquier branch y Pull Requests
# Stages: lint, test-backend, test-frontend, build, coverage
# ============================================

name: CI

on:
  push:
    branches: ['**']
  pull_request:
    branches: [main, develop]

# Cancelar workflows anteriores si hay uno nuevo
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  NODE_VERSION: '20'
  # Variables de prueba
  DATABASE_URL: postgresql://postgres:password@localhost:5432/guelaguetza_test
  REDIS_URL: redis://localhost:6379
  JWT_SECRET: test-jwt-secret-key-for-ci
  JWT_EXPIRES_IN: 7d
  STRIPE_SECRET_KEY: ${{ secrets.STRIPE_TEST_SECRET_KEY }}
  STRIPE_WEBHOOK_SECRET: ${{ secrets.STRIPE_TEST_WEBHOOK_SECRET }}

jobs:
  # ============================================
  # JOB 1: LINT - Backend & Frontend
  # ============================================
  lint:
    name: Lint Code
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      # Cache de node_modules para velocidad
      - name: Cache Frontend node_modules
        uses: actions/cache@v4
        with:
          path: node_modules
          key: ${{ runner.os }}-frontend-node-modules-${{ hashFiles('package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-frontend-node-modules-

      - name: Cache Backend node_modules
        uses: actions/cache@v4
        with:
          path: backend/node_modules
          key: ${{ runner.os }}-backend-node-modules-${{ hashFiles('backend/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-backend-node-modules-

      # Install dependencies
      - name: Install Frontend dependencies
        run: npm ci

      - name: Install Backend dependencies
        run: cd backend && npm ci

      # TypeScript type checking (actúa como lint)
      - name: TypeScript check - Frontend
        run: npx tsc --noEmit

      - name: TypeScript check - Backend
        run: cd backend && npx tsc --noEmit

      # Nota: No hay ESLint configurado en el proyecto actualmente
      # Descomentar cuando se agregue:
      # - name: Lint Frontend
      #   run: npm run lint
      # - name: Lint Backend
      #   run: cd backend && npm run lint

  # ============================================
  # JOB 2: TEST BACKEND - Unit & Integration
  # ============================================
  test-backend:
    name: Test Backend
    runs-on: ubuntu-latest
    timeout-minutes: 15

    # Service containers para PostgreSQL y Redis
    services:
      postgres:
        image: postgres:15-alpine
        env:
          POSTGRES_DB: guelaguetza_test
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: password
          POSTGRES_INITDB_ARGS: "-E UTF8"
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: backend/package-lock.json

      # Cache node_modules
      - name: Cache Backend node_modules
        uses: actions/cache@v4
        with:
          path: backend/node_modules
          key: ${{ runner.os }}-backend-node-modules-${{ hashFiles('backend/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-backend-node-modules-

      - name: Install Backend dependencies
        run: cd backend && npm ci

      # Generar Prisma Client
      - name: Generate Prisma Client
        run: cd backend && npx prisma generate

      # Aplicar migraciones a la BD de prueba
      - name: Run database migrations
        run: cd backend && npx prisma migrate deploy
        env:
          DATABASE_URL: ${{ env.DATABASE_URL }}

      # Tests unitarios
      - name: Run unit tests
        run: cd backend && npm run test -- --run
        env:
          DATABASE_URL: ${{ env.DATABASE_URL }}
          REDIS_URL: ${{ env.REDIS_URL }}
          JWT_SECRET: ${{ env.JWT_SECRET }}

      # Tests de integración
      - name: Run integration tests
        run: cd backend && npm run test:integration
        env:
          DATABASE_URL: ${{ env.DATABASE_URL }}
          REDIS_URL: ${{ env.REDIS_URL }}
          JWT_SECRET: ${{ env.JWT_SECRET }}
          STRIPE_SECRET_KEY: ${{ env.STRIPE_SECRET_KEY }}

      # Coverage
      - name: Generate coverage report
        run: cd backend && npm run test:coverage
        env:
          DATABASE_URL: ${{ env.DATABASE_URL }}
          REDIS_URL: ${{ env.REDIS_URL }}
          JWT_SECRET: ${{ env.JWT_SECRET }}

      # Upload coverage a Codecov (opcional)
      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          files: ./backend/coverage/coverage-final.json
          flags: backend
          name: backend-coverage
          fail_ci_if_error: false

  # ============================================
  # JOB 3: TEST FRONTEND - Unit Tests
  # ============================================
  test-frontend:
    name: Test Frontend
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      # Cache node_modules
      - name: Cache Frontend node_modules
        uses: actions/cache@v4
        with:
          path: node_modules
          key: ${{ runner.os }}-frontend-node-modules-${{ hashFiles('package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-frontend-node-modules-

      - name: Install Frontend dependencies
        run: npm ci

      # Tests unitarios
      - name: Run unit tests
        run: npm run test -- --run

      # Coverage
      - name: Generate coverage report
        run: npm run test:coverage

      # Upload coverage a Codecov (opcional)
      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          files: ./coverage/coverage-final.json
          flags: frontend
          name: frontend-coverage
          fail_ci_if_error: false

  # ============================================
  # JOB 4: BUILD - Verificar que compila
  # ============================================
  build:
    name: Build Application
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: [lint, test-backend, test-frontend]

    strategy:
      matrix:
        node-version: [18, 20, 22]
      fail-fast: false

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'npm'

      # ============================================
      # BUILD FRONTEND
      # ============================================
      - name: Cache Frontend node_modules
        uses: actions/cache@v4
        with:
          path: node_modules
          key: ${{ runner.os }}-frontend-${{ matrix.node-version }}-node-modules-${{ hashFiles('package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-frontend-${{ matrix.node-version }}-node-modules-

      - name: Install Frontend dependencies
        run: npm ci

      - name: Build Frontend
        run: npm run build
        env:
          VITE_API_URL: https://api.guelaguetza-connect.com

      - name: Upload Frontend build artifacts
        if: matrix.node-version == 20
        uses: actions/upload-artifact@v4
        with:
          name: frontend-build
          path: dist/
          retention-days: 7

      # ============================================
      # BUILD BACKEND
      # ============================================
      - name: Cache Backend node_modules
        uses: actions/cache@v4
        with:
          path: backend/node_modules
          key: ${{ runner.os }}-backend-${{ matrix.node-version }}-node-modules-${{ hashFiles('backend/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-backend-${{ matrix.node-version }}-node-modules-

      - name: Install Backend dependencies
        run: cd backend && npm ci

      - name: Generate Prisma Client
        run: cd backend && npx prisma generate

      - name: Build Backend
        run: cd backend && npm run build

      - name: Upload Backend build artifacts
        if: matrix.node-version == 20
        uses: actions/upload-artifact@v4
        with:
          name: backend-build
          path: backend/dist/
          retention-days: 7

  # ============================================
  # JOB 5: COVERAGE SUMMARY
  # ============================================
  coverage-summary:
    name: Coverage Summary
    runs-on: ubuntu-latest
    needs: [test-backend, test-frontend]
    if: github.event_name == 'pull_request'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download backend coverage
        uses: actions/download-artifact@v4
        continue-on-error: true
        with:
          name: backend-coverage

      - name: Download frontend coverage
        uses: actions/download-artifact@v4
        continue-on-error: true
        with:
          name: frontend-coverage

      - name: Comment PR with coverage
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            let comment = '## Coverage Report\n\n';
            
            try {
              if (fs.existsSync('backend-coverage.txt')) {
                const backendCoverage = fs.readFileSync('backend-coverage.txt', 'utf8');
                comment += '### Backend\n```\n' + backendCoverage + '\n```\n\n';
              }
              if (fs.existsSync('frontend-coverage.txt')) {
                const frontendCoverage = fs.readFileSync('frontend-coverage.txt', 'utf8');
                comment += '### Frontend\n```\n' + frontendCoverage + '\n```\n';
              }
            } catch (error) {
              comment += 'Coverage reports not available.\n';
            }

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

  # ============================================
  # STATUS CHECK - Todos los jobs deben pasar
  # ============================================
  ci-status:
    name: CI Status
    runs-on: ubuntu-latest
    needs: [lint, test-backend, test-frontend, build]
    if: always()

    steps:
      - name: Check CI status
        run: |
          if [ "${{ needs.lint.result }}" != "success" ] || \
             [ "${{ needs.test-backend.result }}" != "success" ] || \
             [ "${{ needs.test-frontend.result }}" != "success" ] || \
             [ "${{ needs.build.result }}" != "success" ]; then
            echo "❌ CI failed"
            exit 1
          else
            echo "✅ CI passed"
          fi
